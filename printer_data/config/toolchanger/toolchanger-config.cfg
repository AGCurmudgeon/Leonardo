# THIS IS NOT AN EXHAUSTIVE LIST!
# use this file to override values in the other configs. 
# any value that is available in the configs can be overriden here
# just add the section ie: [tool_probe T0] and the value that is being overridden.  

# this file must be the last file to be included since values will be stored in the order they are
# received.  Klipper will take the last value and store that for the macros. 

[rounded_path]
resolution: 0.2 # the length of a circle approximation segments.
replace_g0: False # Use at your own risk

[force_move]
enable_force_move: True

[toolchanger]
t_command_restore_axis: XYZ
## These are the axis the tool will return its position to. Can be any combination of X,Y, and Z.
## Z is required because of the z hop in the default paths below.
params_safe_toolhead_y: 110
## This is the Y position, with a toolhead on the carriage, that the active toolhead can
## move behind the docked tool without running into the docked tool.
params_safe_shuttle_y: 20  # safe motion with no toolhead present
## This is the Y position, without a toolhead on the carriage, that the carriage can
## move behind the docked tool heads without the magnets pulling on them.
params_close_y: 16
## Y position where the carriage magnets do not pull on the tool plate magnets with the tool docked.
params_attach_y: 2
## Y position where the screws are aligned with the large opening in the docking slots.
params_fast_speed: 24000
## Docking and undocking fast speed in mm per minute. This is the speed used between the print and the close_y parameter.
## This lets us move as fast as we want to between the print and docking area, where we transition to the path_speed.
params_path_speed: 1000
## Docking and undocking path speed in mm per minute. When the tool is put in and pulled from the docking slots.
## This starts at the close_y parameter, and is used for docking and undocking the tool heads.

require_tool_present: False # can set to False if using Beacon/Cartographer/Eddy for Z probe.

# Path positions relative to the park position
# use x,y,z; f= multiplier to path speed; verify= Verify tool detected at end of the move.

# CHANGE THIS!!! Set the path for your printer, see tool_paths.md
params_dropoff_path: []
params_pickup_path: []

# Parking position - per tool
#params_park_x: 142.2
#params_park_y: -6.0
#params_park_z: 308.2
initialize_on: home

error_gcode:
  PAUSE

before_change_gcode:
  {% set tn = "T"+(tool.tool_number|string) %}
  {% if printer["gcode_macro " + tn ] %}
     SET_GCODE_VARIABLE MACRO={tn} VARIABLE=color VALUE="''"
  {% endif %}

after_change_gcode:
  {% set tn = "T"+(tool.tool_number|string) %}
  {% if printer["gcode_macro " + tn ] %}
     SET_GCODE_VARIABLE MACRO={tn} VARIABLE=color VALUE="'c44'"
  {% endif %}
  {% if tool.params_input_shaper_freq_x %}
    SET_INPUT_SHAPER SHAPER_FREQ_X={tool.params_input_shaper_freq_x} SHAPER_FREQ_Y={tool.params_input_shaper_freq_y}
  {% endif %}

dropoff_gcode:
  {% set x = tool.params_park_x|float %}
  {% set y = tool.params_park_y|float %}
  {% set z = tool.params_park_z|float %}
  {% set fast = tool.params_fast_speed|float %}
  {% set path = tool.params_dropoff_path %}
  {% set max_z = printer.configfile.config["stepper_z"]["position_max"]|float %}
  {% set cur_z = printer.toolhead.position[2]|float %}
  RESPOND TYPE=echo MSG='Dropping off {tool.name}'
  G90
  ; Move 1 mm up to avoid crashing into things
  G0 Z{ [cur_z+1.0, max_z]|min } F{fast}
  #   ##############  Move up to the dock  ##############
  ROUNDED_G0 Y={tool.params_safe_y} D=20 F={fast}
  ROUNDED_G0 X={x} D=150 F={fast}
  ROUNDED_G0 Z={z + path[0]['z']|float} D=20 F={fast}
  ROUNDED_G0 Y={y + path[0]['y']|float} D=0 F={fast}
  STOP_CRASH_DETECTION
  #  ############## Run the path ##############
  {% for pos in path %}
    {% set speed = tool.params_path_speed|float * (pos.get('f', 1.0)|float) %}
    G0 {% if 'x' in pos %}X{x + pos['x']|float}{% endif %} {% if 'y' in pos %}Y{y + pos['y']|float}{% endif %} {% if 'z' in pos %}Z{z + pos['z']|float }{% endif %} F{speed}
  {% endfor %}
  ## Return to safe Y if no pickup_tool
  {% if pickup_tool is none %}
    G0 Y{tool.params_safe_y} F{fast}
  {% endif %}
  

pickup_gcode:
  {% set x = tool.params_park_x|float %}
  {% set y = tool.params_park_y|float %}
  {% set z = tool.params_park_z|float %}
  {% set fast = tool.params_fast_speed|float %}
  {% set path = tool.params_pickup_path %}
  RESPOND TYPE=echo MSG='Picking up {tool.name}'
  G90
  #   ##############  Fast to the last point  ##############
  ROUNDED_G0 Y={tool.params_close_y} F={fast} D=5
  ROUNDED_G0 X={x} Z={z + path[0]['z']|float} F={fast} D=5
  ROUNDED_G0 Y={y + path[0]['y']|float} F={fast} D=0
  # Wait for temp before actually picking up the tool, while the nozzle is resting on it's pad.

  {% if tool.extruder %}
    M109 T{tool.tool_number} S{printer[tool.extruder].target|int}
  {% endif %}
  # Run the path
  {% for pos in path %}
    {% set speed = tool.params_path_speed|float * (pos.get('f', 1.0)|float) %}
    G0 {% if 'x' in pos %}X{x + pos['x']|float}{% endif %} {% if 'y' in pos %}Y{y + pos['y']|float}{% endif %} {% if 'z' in pos %}Z{z + pos['z']|float }{% endif %} F{speed}
    {% if 'verify' in pos %}
      VERIFY_TOOL_DETECTED T={tool.tool_number}
    {% endif %}
  {% endfor %}
  # Restore the position with smooth rounded move.
  ROUNDED_G0 Y={tool.params_safe_y} F={fast} D=20
  {% if 'Z' in restore_position %}
    ROUNDED_G0 Z={restore_position.Z} F={fast} D=150
  {% endif %}
  {% if 'X' in restore_position %}
    ROUNDED_G0 X={restore_position.X} F={fast} D=1000
  {% endif %}
  {% if 'Y' in restore_position %}
    ROUNDED_G0 Y={restore_position.Y} F={fast} D=0
  {% endif %}
  ROUNDED_G0 D=0

[gcode_macro RESUME]
rename_existing: RESUME_BASE
gcode:
  INITIALIZE_TOOLCHANGER
  VERIFY_TOOL_DETECTED
  RESUME_BASE

[gcode_macro TOOL_ALIGN_START]
gcode:
    INITIALIZE_TOOLCHANGER # Detect current tool
    _TOOL_ALIGN_START

[gcode_macro _TOOL_ALIGN_START]
gcode:
    {% set tool = printer[printer.toolchanger.tool] %}
    SET_TOOL_PARAMETER PARAMETER='params_path_speed' VALUE=300
    SET_GCODE_OFFSET X=0 Y=0 Z=0
    G0 Y{tool.params_safe_y} F{tool.params_fast_speed}
    G0 X{tool.params_park_x} Z{tool.params_park_z}
    G0 Y{tool.params_park_y|float + 100.0}

[gcode_macro TOOL_ALIGN_TEST]
gcode:
    {% set curpos = printer.gcode_move.gcode_position %}
    {% if curpos[1] > 0 %}
      # Check if Y is not too far, to very unrealistic tests.
      RESPOND TYPE=error MSG='Test aborted. Tool too far away from the dock.'
    {% else %}
      INITIALIZE_TOOLCHANGER # Detect current tool
      SET_GCODE_OFFSET X=0 Y=0 Z=0
      SET_TOOL_PARAMETER PARAMETER='params_park_x' VALUE={curpos[0]}
      SET_TOOL_PARAMETER PARAMETER='params_park_y' VALUE={curpos[1]}
      SET_TOOL_PARAMETER PARAMETER='params_park_z' VALUE={curpos[2]}
      TEST_TOOL_DOCKING RESTORE_AXIS=XYZ
    {% endif %}

[gcode_macro TOOL_ALIGN_DONE]
gcode:
    {% set tool = printer[printer.toolchanger.tool] %}
    SAVE_TOOL_PARAMETER PARAMETER='params_park_x'
    SAVE_TOOL_PARAMETER PARAMETER='params_park_y'
    SAVE_TOOL_PARAMETER PARAMETER='params_park_z'
    RESET_TOOL_PARAMETER PARAMETER='params_path_speed'
    G0 Y{tool.params_safe_y} F{tool.params_fast_speed}

# this section must be completed
[gcode_macro homing_override_config]
variable_sensorless_x: False
variable_sensorless_y: False
variable_homing_rebound_y: 10 # for sensorless you probably want this set to 20.
variable_stepper_driver: "tmc2209"
variable_homing_current: 0.49

# # M109 macro is overridden to allow some deadband on the temp
# # default is +- 1 degree.  So if the set temp is 250 the the default
# # deadband will be 249-251.  You can adjust this here:

[gcode_macro SET_TEMPERATURE_WITH_DEADBAND]
variable_default_deadband: 4.0

[gcode_macro STOP_FILAMENT_SENSORS]
gcode:
  SET_FILAMENT_SENSOR SENSOR="switch_sensor_T0" ENABLE=0
  SET_FILAMENT_SENSOR SENSOR="encoder_sensor_T0" ENABLE=0
  SET_FILAMENT_SENSOR SENSOR="switch_sensor_T1" ENABLE=0
  SET_FILAMENT_SENSOR SENSOR="encoder_sensor_T1" ENABLE=0
  # RESPOND TYPE=echo MSG="Filament sensors stopped"

# # these values need to be set to match the location of your Calibration Switch
# [gcode_macro _CALIBRATION_SWITCH]
# variable_x: 227.471875
# variable_y: 353.703125
# variable_z: 5.00
# gcode:

# # [tools_calibrate]
# # pin: PG11 #pin that your calibration probe is connected to.
# # travel_speed: 20  # mms to travel sideways for XY probing
# # spread: 7  # mms to travel down from top for XY probing
# # lower_z: 1.0  # The speed (in mm/sec) to move tools down onto the probe
# # speed: 2  # The speed (in mm/sec) to retract between probes
# # lift_speed: 4  # Z Lift after probing done, should be greater than any Z variance between tools
# # final_lift_z: 6 
# # sample_retract_dist:2
# # samples_tolerance:0.05
# # samples:5
# # samples_result: median # median, average
# # # Settings for nozzle probe calibration - optional.
# # #probe: probe # name of the nozzle probe to use
# # #trigger_to_bottom_z: 0.25 # Offset from probe trigger to vertical motion bottoms out. 
# # decrease if the nozzle is too high, increase if too low.
